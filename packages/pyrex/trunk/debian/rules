#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatibility version to use.
export DH_OPTIONS
#export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make

PYTHON := $(shell pyversions -d)
PYVERS := $(shell pyversions -vr debian/control)
PYVER  := $(shell $(PYTHON) -c 'import sys; print sys.version[:3]')
PYREXC=pyrexc

with_pyrex_mode = no
ifneq ($(with_pyrex_mode),yes)
DH_OPTIONS = -Npyrex-mode
endif

configure: configure-stamp
configure-stamp: patch-stamp
	dh_testdir
	# nothing to do
	touch configure-stamp

build: build-stamp
build-stamp: configure-stamp 
	# make sure most files are not executable
	find [DPTCs]* -type f -exec chmod -x {} \;
	dh_testdir
	# nothing to do
	touch build-stamp

clean: clean1st unpatch
clean1st:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	$(PYTHON) setup.py clean --all ;\
	# delete *.pyc generated by setup.py
	find . -name '*.pyc' -exec rm -rf {} \;
	rm -f build-stamp
	
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs

	# fix executable file : headers, names 
	# $$file -> python$$version-$$file
	$(PYTHON) setup.py install --root=$(CURDIR)/debian/python-pyrex --no-compile --install-layout=deb
	for python in $(PYVERS); do \
		sed 's/#VERS#/'$$python'/g' debian/pythonX.Y-pyrexc > debian/python-pyrex/usr/bin/python$$python-pyrexc ; \
		chmod 755 debian/python-pyrex/usr/bin/python$$python-pyrexc ; \
	done
ifeq ($(with_pyrex_mode),yes)
	dh_install -p pyrex-mode
endif

binary-common: 

	dh_testdir
	dh_testroot
	dh_installdebconf	
	dh_installchangelogs CHANGES.txt
	dh_installdocs
	dh_installemacsen
	dh_installexamples
	dh_installman debian/pyrexc.1
	# default version link for binary and manpage
	for python in $(PYVERS); \
		do dh_link -ppython-pyrex \
			usr/share/man/man1/$(PYREXC).1.gz \
			usr/share/man/man1/python$$python-$(PYREXC).1.gz ;\
	done
	dh_strip
	dh_compress
	dh_fixperms
	dh_pycentral
	# remove empty dir after pycentral moved its content
	-$(RM) -r debian/python-pyrex/usr/lib
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-independent files here.
binary: build install
	$(MAKE) -k -f debian/rules DH_OPTIONS="-i $(DH_OPTIONS)" binary-common
	
.PHONY: build clean binary-indep binary-arch binary install configure unpatch clean1st
